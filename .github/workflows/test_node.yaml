name: test_node

on:
  pull_request:

concurrency:
  group: test_node-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test_node:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - run: npm ci
    - run: npm run auto_downport
    - run: npm run auto_transpile
    - run: npm run express &
    - name: Wait for server and verify response
      run: |
        for i in $(seq 1 30); do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null) || true
          if [ "$HTTP_CODE" != "000" ]; then
            break
          fi
          sleep 1
        done
        if [ "$HTTP_CODE" = "000" ]; then
          echo "::error::Server did not start within 30 seconds"
          exit 1
        fi
        if [ "$HTTP_CODE" != "200" ]; then
          echo "::error::Server returned HTTP $HTTP_CODE"
          curl -s http://localhost:3000
          exit 1
        fi
        BODY_LENGTH=$(curl -s http://localhost:3000 | wc -c)
        if [ "$BODY_LENGTH" -lt 1000 ]; then
          echo "::error::Response body too small ($BODY_LENGTH bytes), likely an error page"
          curl -s http://localhost:3000
          exit 1
        fi
        echo "Server started successfully (HTTP $HTTP_CODE, $BODY_LENGTH bytes)"
